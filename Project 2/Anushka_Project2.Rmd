---
title: "Anushka Project 2"
author: "Anushka Vuppala, David Li, Tyler Wallett"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(ggplot2)
library(ezids)
```

```{r, results='markup'}
ipums = read_csv("ipums.csv")
str(ipums)

#Dropping unnecessary columns: YEAR, EDUCD and EMPSTATD
library(dplyr)
ipums = select(ipums, c(2:6,8,9:10))

str(ipums)


sum(is.na(ipums))
```

# EDA

## EMPSTAT reformatting
```{r, results='markup'}
#Reformatting target column: EMPSTAT

#Checking for unique values
unique(ipums$EMPSTAT)

#According to IPUMS, codes are the following:
# 0 = N/A
# 1 = Employed
# 2 = Unemployed
# 3 = Not in labor force

#Dropping 0 and 3 values
ipums$EMPSTAT <- replace(ipums$EMPSTAT, ipums$EMPSTAT == 0, NA)
ipums$EMPSTAT <- replace(ipums$EMPSTAT, ipums$EMPSTAT == 3, NA)

ipums <- na.omit(ipums)

#Reformatting column to:
# 0 = Unemployed
# 1 = Employed

ipums$EMPSTAT[ipums$EMPSTAT == 2] <- 0

ipums$EMPSTAT <- as.factor(ipums$EMPSTAT)
```

## GENDER reformatting
```{r, results='markup'}
# 1 => Male
# 2 => Female

library("dplyr")

# renaming the column
ipums = ipums %>% rename("GENDER" = "SEX")
print(colnames(ipums))

dat <- data.frame(table(ipums$GENDER,ipums$EMPSTAT))
names(dat) <- c("GENDER","EMPSTAT","Count")
# for purpose of plotting
dat["GENDER"] = c("Male","Female","Male","Female")

# plotting
ggplot(data=dat, aes(x=GENDER, y=Count)) + geom_bar(aes(fill = EMPSTAT), stat="identity")+ scale_fill_discrete(labels = c("UNEMPLOYED", "EMPLOYED")) 


```


# INDUSTRY

```{r, results='markup'}
# INDNAICS
ipums = ipums %>% mutate(INDUSTRY = 
  case_when(
    startsWith(INDNAICS,"0") ~ "Not_Applicable",
    startsWith(INDNAICS,"1") ~ "Agriculture",
    startsWith(INDNAICS,"2") ~ "Utilities",
    startsWith(INDNAICS,"3") ~ "Manufacturing",
    startsWith(INDNAICS,"4") ~ "Retail",
    startsWith(INDNAICS,"5") ~ "Finance",
    startsWith(INDNAICS,"6") ~ "Education and Health",
    startsWith(INDNAICS,"7") ~ "Hospitalioty",
    startsWith(INDNAICS,"8") ~ "Other",
    startsWith(INDNAICS,"9") ~ "Military"
  )
)

# plotting

gender_name <- c(
  `1`="Male",
  `2`="Female"
)
gender_labeller <- function(variable,value){
  return(gender_name[value])
}
ipums$EMPSTAT = as.factor(ipums$EMPSTAT)
ggplot(ipums, aes(INDUSTRY, ..count..)) + geom_bar(aes(fill = EMPSTAT), position = "dodge") +
facet_wrap(GENDER ~ ., labeller = gender_labeller) + theme(axis.text.x = element_text(angle = 45, hjust=1))+ scale_fill_discrete(labels = c("UNEMPLOYED", "EMPLOYED"))

```

# SMOTE
## DO NOT RUN
```{r, results='markup'}

#library(DMwR)
# install.packages("smotefamily")
#library(smotefamily)

#ipums_anushka_x=ipums_anushka %>% select("GENDER","AGE","CITIZEN","EDUC","WORKEDYR")
#smote <- SMOTE(ipums_anushka_x, ipums["EMPSTAT"])

```

# Downsampling
```{r, results='markup'}
set.seed(123)
ipums_employed = (ipums %>% filter(EMPSTAT==1))
ipums_not_employed = (ipums %>% filter(EMPSTAT==0))

ipums_sample_employed = ipums_employed[sample(nrow(ipums_employed),nrow(ipums_not_employed)),]
ipums_model_data= rbind(ipums_sample_employed, ipums_not_employed)
nrow(ipums_model_data)

# Let's plot our industry vs gender vs empstatus again to see the distribution after sampling
ggplot(ipums_model_data, aes(INDUSTRY, ..count..)) + geom_bar(aes(fill = EMPSTAT), position = "dodge") + facet_wrap(GENDER ~ ., labeller = gender_labeller) + theme(axis.text.x = element_text(angle = 45, hjust=1))+ scale_fill_discrete(labels = c("UNEMPLOYED", "EMPLOYED"))
```


# Splitting into train and test data

```{r, results='markup'}

ipums_model_data = ipums_model_data %>% select(GENDER, AGE, MARST, CITIZEN, INDUSTRY, EDUC, EMPSTAT)

# refactor into numeric
ipums_model_data$EMPSTAT = as.numeric(ipums_model_data$EMPSTAT)
ipums_model_data$INDUSTRY = as.numeric(unclass(as.factor(ipums_model_data$INDUSTRY)))
ipums_model_data$MARST = as.numeric(ipums_model_data$MARST)
ipums_model_data$GENDER = as.numeric(ipums_model_data$GENDER)
ipums_model_data$AGE = as.numeric(ipums_model_data$AGE)
ipums_model_data$CITIZEN = as.numeric(ipums_model_data$CITIZEN)
ipums_model_data$EDUC = as.numeric(ipums_model_data$EDUC)


## 75% of the sample size
smp_size <- floor(0.75 * nrow(ipums_model_data))

## set the seed to make your partition reproducible
set.seed(123)
train_data_size <- sample(seq_len(nrow(ipums_model_data)), size = smp_size)

#train <- ipums_model_data[train_data_size,]
#test <- ipums_model_data[-train_data_size,]
train <- ipums_model_data[train_data_size,]
test <- ipums_model_data[-train_data_size,]


train.labels = ipums_model_data[train_data_size,c("EMPSTAT")]
test.labels = ipums_model_data[-train_data_size,c("EMPSTAT")]

paste0("Number of employed people in training set = ", (nrow(train %>% filter(EMPSTAT==1))))
paste0("Number of unemployed people in training set = ", (nrow(train %>% filter(EMPSTAT==0))))

paste0("Number of employed people in testing set = ", (nrow(test %>% filter(EMPSTAT==1))))
paste0("Number of unemployed people in testing set = ", (nrow(test %>% filter(EMPSTAT==0))))
```


# KNN
```{r, results='markup'}
library(class)
knn.27 <- knn(train=train, test=test, cl=train.labels, k=27)
ACC.27=100 * sum(test.labels == knn.27)/NROW(test.labels)
paste0("Accuracy = ", ACC.27)
```


